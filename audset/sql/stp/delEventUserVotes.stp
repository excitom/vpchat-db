/* Deletes all user votes from the userVotes table (at the end of an event).
   Keeps the totals in the voteOptions table. */
/* input:  eventID. 
   output: None
*/
CREATE PROC delEventUserVotes
(
  @eventID		numeric(6,0)
)
AS
BEGIN
  DECLARE @lastError int
  DECLARE @voteID numeric(10,0)

  BEGIN TRAN
 
  DECLARE eventVotesC CURSOR
  FOR 
  SELECT voteID 
    FROM eventVotes
    WHERE eventID = @eventID
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    ROLLBACK TRAN
    RETURN @lastError
  END
 
  OPEN eventVotesC
  FETCH eventVotesC INTO @voteID
  WHILE ( @@sqlstatus = 0 ) 
  BEGIN
    EXEC delUserVotes @voteID
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END
    FETCH eventVotesC INTO @voteID
  END
  CLOSE eventVotesC
  
  COMMIT TRAN  
END
GO
