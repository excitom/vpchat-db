/* --- Clear, for a given event and interaction type,
       all the interactions of that type that are 
       in the eventInteractions table.
*/
/* input:  event id, interactionType
   output: error 20001 if too many interaction types are given.
   21/07/97: Fix - clear only answers for THIS event!
*/
CREATE PROC clearInteractions
(
  @eventID		numeric(10,0),
  @interactionTypes	longName
)
AS
BEGIN
/* Get Interaction Types requested ... */
/* ------------------------------------*/
DECLARE @iType    integer
DECLARE @iType1   integer
DECLARE @iType2   integer 
DECLARE @iType3   integer 
DECLARE @iType4   integer 
DECLARE @iType5   integer 
DECLARE @iType6   integer 
DECLARE @counter  integer
DECLARE @commaPos integer
DECLARE @IName    varchar(16)
DECLARE @lastError integer

/* Parse list of interaction types */
/* --------------------------------*/
SELECT @counter = 1
WHILE ( ascii( rtrim(ltrim(@interactionTypes))) > 32 )
BEGIN
  SELECT @commaPos = patindex( "%,%", @interactionTypes )
  IF @commaPos = 0 BEGIN
    /* Last Interaction Type in list */
    SELECT @IName = rtrim(ltrim(@interactionTypes))
    SELECT @interactionTypes = ""
  END
  ELSE BEGIN
    SELECT @IName = rtrim( ltrim( substring( @interactionTypes, 1, @commaPos-1)) )
    SELECT @interactionTypes = substring( @interactionTypes, 
                                          @commaPos+1, 
                                          char_length( @interactionTypes ) - @commaPos )
  END

  /* Get the Interaction Type for the current Interaction Name */
  SELECT @iType = interactionType
  FROM interactionsAllowed
  WHERE eventID = @eventID AND 
        name = @IName
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    RAISERROR @lastError
    RETURN @lastError
  END
  
  IF @counter = 1 
     SELECT @iType1 = @iType
  ELSE IF @counter = 2 
     SELECT @iType2 = @iType
  ELSE IF @counter = 3 
     SELECT @iType3 = @iType
  ELSE IF @counter = 4 
     SELECT @iType4 = @iType
  ELSE IF @counter = 5 
     SELECT @iType5 = @iType
  ELSE IF @counter = 6 
     SELECT @iType6 = @iType
  ELSE 
    RETURN 20001 /* Too many Interaction Types */

  SELECT @counter = @counter + 1

END /* of while */

/* Set zero in unused iTypes variables */
WHILE @counter <= 6
BEGIN
  IF @counter = 1 
     SELECT @iType1 = 0
   ELSE IF @counter = 2 
     SELECT @iType2 = 0
  ELSE IF @counter = 3 
     SELECT @iType3 = 0
  ELSE IF @counter = 4 
     SELECT @iType4 = 0
  ELSE IF @counter = 5 
     SELECT @iType5 = 0
  ELSE IF @counter = 6 
     SELECT @iType6 = 0
  SELECT @counter = @counter + 1
END

/* Now delete appropriate interactions */
BEGIN TRAN clearInteractions
  DELETE answers
  WHERE interactionID IN 
    (SELECT interactionID 
     FROM eventInteractions ( INDEX interactionsByEventIdx )
     WHERE eventID = @eventID AND
           interactionType IN (@iType1, @iType2, @iType3, @iType4, @iType5, @iType6))
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    ROLLBACK TRAN clearInteractions
    RAISERROR @lastError
    RETURN @lastError
  END
  
  DELETE eventInteractions
  FROM eventInteractions ( INDEX interactionsByEventIdx )
  WHERE eventID = @eventID AND
        interactionType IN(@iType1, @iType2, @iType3, @iType4, @iType5, @iType6)
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    ROLLBACK TRAN clearInteractions
    RAISERROR @lastError
    RETURN @lastError
  END
COMMIT TRAN clearInteractions

END
GO 
