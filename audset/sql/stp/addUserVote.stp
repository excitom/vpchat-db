/* Adds a user vote selection to the userVotes table */
/* input:  eventId, vote option id, user name. 
   output: error codes:
           - 20001: Vote not active,
           - 20002: Invalid option id,
           - 20003: Too many options selected,
*/
CREATE PROC addUserVote
(
  @voteID		numeric(10,0),
  @optionID		integer,
  @userName             VPuserID = NULL
)
AS
BEGIN
  DECLARE @diffFromGMT int
  DECLARE @currentDate VpTime
  DECLARE @numChoices  int
  DECLARE @lastSelection int
  DECLARE @lastError   int
  DECLARE @status      int

  /* Get the event's active vote id */
  SELECT @status = status, @numChoices = numChoices 
    FROM eventVotes
    WHERE voteID = @voteID 
  SELECT @lastError = @@error
  IF @lastError != 0
    RETURN @lastError
 
  IF @status != 1 
    return 20001	/* Vote not active */
  
  /* Check that the option is valid */
  SELECT optionID 
    FROM voteOptions
    WHERE voteID = @voteID AND
          optionID = @optionID
  IF @@rowCount = 0 
    RETURN 20002    /* Invalid option id */
  SELECT @lastError = @@error
  IF @lastError != 0
    RETURN @lastError
  
  /* Check that this user, if identified, has not already voted */ 
  IF @userName IS NOT NULL
  BEGIN
    SELECT @lastSelection = optionID
      FROM userVotes
      WHERE name = @userName AND
            voteID = @voteID
    IF @@rowcount >= @numChoices
      RETURN 20003	/* Too many options selected */
    SELECT @lastError = @@error
    IF @lastError != 0
      RETURN @lastError
  END

  SELECT @diffFromGMT = gmt
  FROM vpusers..getGMT
    
  SELECT @lastError = @@error
  IF @lastError != 0
    RETURN @lastError
    
  /* Add this user vote to the table */
  INSERT INTO userVotes 
      ( voteID, optionID, name, time)
    VALUES ( @voteID, @optionID, @userName, 
 	     dateadd( hour, (-1) * @diffFromGMT, getdate() ) )
    
END
GO
