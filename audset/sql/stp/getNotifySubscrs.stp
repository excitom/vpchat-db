/*
 * Get subscribers to a notify list.
 *
 * Input: notifyID
 *
 * A distinction may be made between a private alert list and an
 * alert list associated with a game ladder. 
 *
 * Output: 0 = success
 *         20000 = list not found
 *
 */
CREATE PROC getNotifySubscrs (
	@notifyID	userIdentifier,
	@type		int = 0		-- default = any type
)
AS
BEGIN
  DECLARE @lastError	int

  BEGIN TRAN
   IF @type = 0
   BEGIN
    IF EXISTS (SELECT *
		FROM notifyLists
		WHERE notifyID = @notifyID)
    BEGIN
      SELECT s.userID, u.nickName, s.notifyPref
        FROM notifySubscrs s, vpusers..users u, notifyLists n
        WHERE s.notifyID = @notifyID
        AND s.userID=u.userID
        AND s.notifyID=n.notifyID
        AND u.registrationMode = 2
        AND u.locked = 0
        ORDER BY u.nickName ASC

      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN
        RETURN @lastError
      END
    END
    ELSE BEGIN
      ROLLBACK TRAN
      RETURN 20000
    END
   END
   ELSE BEGIN
    IF EXISTS (SELECT *
		FROM notifyLists
		WHERE notifyID = @notifyID
		AND type & @type = @type)
    BEGIN
      SELECT s.userID, u.nickName, s.notifyPref
        FROM notifySubscrs s, vpusers..users u, notifyLists n
        WHERE s.notifyID = @notifyID
        AND s.userID=u.userID
        AND s.notifyID=n.notifyID
        AND u.registrationMode = 2
        AND u.locked = 0
        AND n.type & @type = @type
        ORDER BY u.nickName ASC

      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN
        RETURN @lastError
      END
    END
    ELSE BEGIN
      ROLLBACK TRAN
      RETURN 20000
    END
   END
  COMMIT
END
GO
