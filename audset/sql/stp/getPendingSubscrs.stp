/*
 * Find pending requests to subscribe to a private list
 *
 * A distinction may be made between a private alert list and an
 * alert list associated with a game ladder. 
 *
 * Input: List ID
 *
 * Output: 0 = success
 *         20000 = list not found 
 */
IF EXISTS(SELECT name FROM sysobjects WHERE name='getPendingSubscrs' AND type='P')
 DROP PROC getPendingSubscrs
GO
CREATE PROC getPendingSubscrs (
	@notifyID	userIdentifier,
	@type		int = 0x00000040	-- default = private alert list
)
AS
BEGIN
  DECLARE @lastError	int

  BEGIN TRAN
    IF NOT EXISTS (SELECT * FROM notifyLists
			WHERE notifyID = @notifyID
			AND type & @type = @type)
    BEGIN
      ROLLBACK TRAN
      RETURN 20000
    END

    SELECT u.userID, nickName, notifyPref
      FROM vpusers..users u, pendingListSubscrs p, notifyLists n
      WHERE p.notifyID = @notifyID
      AND u.userID = p.userID
      AND registrationMode = 2
      AND p.notifyID = n.notifyID
      AND n.type & @type = @type
      ORDER BY nickName ASC

    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END
  COMMIT TRAN
END
GO
