/* start or stop a given vote  */
/* input:  vote ID, status ( 1 = start, 2 = over )
   output: error values - 
            20001: status unchanged,
            20002: another vote is active for this event,
                           
*/
CREATE PROC changeVoteStatus(
        @voteID 	numeric(10,0),
        @status	 	int
)
AS
BEGIN

  DECLARE @currentStatus int
  DECLARE @eventID       eventIdentifier
  DECLARE @otherVote     numeric(10,0)
  DECLARE @lastError	 int

  SELECT @currentStatus = status
    FROM eventVotes
    WHERE voteID = @voteID
  SELECT @lastError = @@error
  IF @lastError != 0
    RETURN @lastError

  IF @status = @currentStatus
    RETURN 20001

  IF @status = 1 /* start vote */
  BEGIN
    SELECT @eventID = eventID
      FROM eventVotes
      WHERE eventVotes.voteID = @voteID
    SELECT @lastError = @@error
    IF @lastError != 0
      RETURN @lastError

    SELECT @otherVote = voteID
      FROM eventVotes
      WHERE eventID = @eventID AND status = 1
    SELECT @lastError = @@error
    IF @lastError != 0
      RETURN @lastError

    IF @otherVote IS NOT NULL
      RETURN 20002	/* Another vote is active for this event */
  END

  UPDATE eventVotes
   SET status = @status
   WHERE voteID = @voteID

  SELECT @status

END
GO
