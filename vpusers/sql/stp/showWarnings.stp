/* --- show all penalties (active and expired) and warnings for all users --- */
/* this is an interface for calling from an HTML GUI */
CREATE PROC showWarnings
( 
  @when smalldatetime,
  @sortBy int,
  @diffFromGMT int
)
AS
BEGIN
  /* sortBy 
  	1 = victim
	2 = date/time
	3 = host
  */

  DECLARE @lastError int
  DECLARE @start smalldatetime
  DECLARE @end smalldatetime
  
  BEGIN TRAN
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

    SELECT @start = dateadd( hour, (-1) * (@diffFromGMT), @when )
    SELECT @end = dateadd( hour, 24, @start )

    /* ------------------------ sort by victim ------------------------ */
    IF ( @sortBy = 1 )
    BEGIN
      SELECT warningsWithNames.Name, 
          dateadd( hour, (@diffFromGMT), warnings.issuedOn) AS "Issued On", 
          warningsWithNames.issuer AS "Issued By",
	  content
        FROM warningsWithNames,warnings
	WHERE warningsWithNames.issuedOn >= @start 
          AND warningsWithNames.issuedOn < @end
	  AND Id=warnings.warningID
      ORDER BY warningsWithNames.Name
      
      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN
        RETURN @lastError
      END
      COMMIT TRAN
      RETURN
    END

    /* ------------------------ sort by date/time  ------------------------ */
    IF ( @sortBy = 2 )
    BEGIN
      SELECT warningsWithNames.Name, 
          dateadd( hour, (@diffFromGMT), warnings.issuedOn) AS "Issued On", 
          warningsWithNames.issuer AS "Issued By",
	  content
        FROM warningsWithNames,warnings
	WHERE warningsWithNames.issuedOn >= @start 
          AND warningsWithNames.issuedOn < @end
	  AND Id=warnings.warningID
      ORDER BY warningsWithNames.issuedOn
      
      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN
        RETURN @lastError
      END
      COMMIT TRAN
      RETURN
    END

    /* ------------------------ sort by host ------------------------ */
    IF ( @sortBy = 3 )
    BEGIN
      SELECT warningsWithNames.Name, 
          dateadd( hour,(@diffFromGMT), warnings.issuedOn) AS "Issued On", 
          warningsWithNames.issuer AS "Issued By",
	  content
        FROM warningsWithNames,warnings
	WHERE warningsWithNames.issuedOn >= @start 
          AND warningsWithNames.issuedOn < @end
	  AND Id=warnings.warningID
      ORDER BY warningsWithNames.issuer
      
      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN
        RETURN @lastError
      END
      COMMIT TRAN
      RETURN
    END
  
  COMMIT TRAN
END
GO 
