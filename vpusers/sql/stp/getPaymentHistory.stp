/*
 * Show payment report for an account
 *
 * This is an interface for calling from an HTML GUI
 *
 */
CREATE PROC getPaymentHistory
( 
  @accountID userIdentifier,
  @clientTZ int = 0
)
AS
BEGIN

  DECLARE @lastError int
  
  SELECT payments.paymentID, dateadd(hour, @clientTZ, paymentDate),
         amount,comment, balance,
         AVS_result,shopperID,orderID,approvalCode, NULL, pmtType, ccID
    FROM payments,ccPayments,runningBalance
	WHERE accountID = @accountID
    AND ccPayments.paymentID = payments.paymentID
    AND runningBalance.paymentID = payments.paymentID
  UNION
  SELECT payments.paymentID, dateadd(hour, @clientTZ, paymentDate),
         amount,comment, balance,
         NULL,NULL,NULL,NULL, NULL, NULL, NULL
    FROM payments, runningBalance
	WHERE accountID = @accountID
    AND runningBalance.paymentID = payments.paymentID
    AND NOT EXISTS (
      SELECT * FROM ccPayments
        WHERE ccPayments.paymentID = payments.paymentID )
  UNION
  SELECT paymentID, dateadd(hour, @clientTZ, paymentDate),
         amount,comment, 0,
         AVS_result,shopperID,orderID,approvalCode, status, pmtType, ccID
    FROM heldPayments
	WHERE accountID = @accountID
  ORDER BY dateadd(hour, @clientTZ, paymentDate) ASC, paymentID ASC
  
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    ROLLBACK TRAN
    RETURN @lastError
  END

END
GO
