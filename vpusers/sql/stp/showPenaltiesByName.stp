/* --- show all penalties (active and expired) for a user --- */
/* this is an interface for calling from an HTML GUI
 *
 * There are potentially two different time zones involved, for the 
 * web page user and for the server on which the database is running.
 * Penalty times are saved in GMT. To determine is a penalty is expired,
 * we need to determine "now" relative to the server on which the database
 * is running. When we present the expiration time/date, we want to 
 * adjust for the time zone of the web page user.
 *
 * The input parameter is the time zone of the web page user.
 *
 */
CREATE PROC showPenaltiesByName
( 
  @nickName VPuserID,
  @clientTZ int
)
AS
BEGIN
  DECLARE @lastError int
  DECLARE @now smalldatetime
  DECLARE @diffFromGMT int

  SELECT @diffFromGMT = gmt
    FROM getGMT
  IF @diffFromGMT IS NULL
    SELECT @diffFromGMT = 0
    
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    RETURN @lastError
  END
  
  SELECT @now = dateadd( hour, (-1) * @diffFromGMT, getdate() )

  SELECT Id, Name, Mode,
         Penalty, 
         dateadd( hour, (@clientTZ), issuedOn) AS "Issued On", 
         issuer AS "Issued By", 
         ( (1-forgiven) * 
           (sign(sign(datediff(minute,@now,expiresOn))-1)+1))
           AS "In Effect",
         dateadd( hour, (@clientTZ), expiresOn) AS "Expires On",
         comment
    FROM penaltiesWithNames
    WHERE Name = @nickName

  UNION
  SELECT Id, Name, Mode,
         Penalty, 
         dateadd( hour, (@clientTZ), issuedOn) AS "Issued On", 
         issuer AS "Issued By", 
         0 AS "In Effect",
         dateadd( hour, (@clientTZ), expiresOn) AS "Expires On",
         comment
    FROM historyWithNames
    WHERE Name = @nickName
    
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    ROLLBACK TRAN
    RETURN @lastError
  END

  COMMIT TRAN
END
GO
