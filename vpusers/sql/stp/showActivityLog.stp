/*
 * Show activity log for an account
 * input:  accountID
 *         flag, 1 = ascending date/time, 0 = descending
 *         client time zone (output date/time is relative to this TZ)
 *         from/to date/time range 
 *
 *	If both from and to are null, show all.
 *
 * output: Return value - 0 - success 
 *		 	  20000 - can't find account 
 *			  20001 - missing from or to date
 *
 */
IF EXISTS(SELECT name FROM sysobjects WHERE name='showActivityLog' AND type='P')
 DROP PROC showActivityLog
GO
CREATE PROC showActivityLog ( 
	@accountID 	userIdentifier,
	@asc		bit = 1,
	@clientTZ	int = NULL,
	@from		VpTime = NULL,
	@to		VpTime = NULL
)
AS
BEGIN
  DECLARE @comment	longName
  DECLARE @IP  		varchar(20)
  DECLARE @who		VPuserID
  DECLARE @time		VpTime
  DECLARE @found	bit

  IF @clientTZ IS NULL
  BEGIN
    SELECT @clientTZ = gmt
      FROM getGMT
    IF @clientTZ IS NULL
      SELECT @clientTZ = 0
  END

  SELECT @found = 0

  IF @from IS NULL AND @to IS NULL
  BEGIN
    IF @accountID = 0
    BEGIN
      SELECT @from = dateadd(hour, (-1) * @clientTZ, getdate())
      SELECT @from = dateadd(hour, -24, @from)
      IF @asc = 1
      BEGIN
        SELECT dateadd(hour, @clientTZ, time), comment, who, IP
           FROM activityLog
           WHERE time >= @from
           ORDER BY time ASC
      END
      ELSE BEGIN
        SELECT dateadd(hour, @clientTZ, time), comment, who, IP
           FROM activityLog
           WHERE time >= @from
           ORDER BY time DESC
      END
    END
    ELSE BEGIN
      IF @asc = 1
      BEGIN
        SELECT dateadd(hour, @clientTZ, time), comment, who, IP
           FROM activityLog
           WHERE accountID = @accountID
           ORDER BY time ASC
      END
      ELSE BEGIN
        SELECT dateadd(hour, @clientTZ, time), comment, who, IP
           FROM activityLog
           WHERE accountID = @accountID
           ORDER BY time DESC
      END
    END
    RETURN 0
  END

  IF @from IS NULL OR @to IS NULL
  BEGIN
    RETURN 20001
  END

  SELECT @from = dateadd( hour, (-1) * @clientTZ, @from )
  SELECT @to   = dateadd( hour, (-1) * @clientTZ, @to   )

  IF @accountID = 0
  BEGIN
    -- Show activity from all accounts in the range
    IF @asc = 1
    BEGIN
      SELECT dateadd(hour, @clientTZ, time), comment, who, IP
         FROM activityLog
         WHERE time >= @from
         AND   time <= @to
         ORDER BY time ASC
    END
    ELSE BEGIN
      SELECT dateadd(hour, @clientTZ, time), comment, who, IP
         FROM activityLog
         WHERE time >= @from
         AND   time <= @to
         ORDER BY time DESC
    END
  END
  ELSE BEGIN
    -- Showing a specific account
    IF @asc = 1
    BEGIN
      SELECT dateadd(hour, @clientTZ, time), comment, who, IP
         FROM activityLog
         WHERE accountID = @accountID
         AND   time >= @from
         AND   time <= @to
         ORDER BY time ASC
    END
    ELSE BEGIN
      SELECT dateadd(hour, @clientTZ, time), comment, who, IP
         FROM activityLog
         WHERE accountID = @accountID
         AND   time >= @from
         AND   time <= @to
         ORDER BY time DESC
    END
  END
END
GO
IF OBJECT_ID('dbo.showActivityLog') IS NOT NULL
        PRINT '<<< CREATED PROCEDURE dbo.showActivityLog >>>'
ELSE
        PRINT '<<< FAILED CREATING PROCEDURE dbo.showActivityLog >>>'
GO
