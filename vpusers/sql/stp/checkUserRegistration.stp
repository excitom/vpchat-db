/* check user password */
/* input:  user name, time (GMT)
   output: password of user if it exists */
CREATE PROC checkUserRegistration 
( 
  @nickName VPuserID
)
AS
BEGIN
  --  set isolation level to 0
  set transaction isolation level 0
  
  /* dummy table to return empty result set */
  /* original definition of type is: 
     sp_addtype VPPassword, "varchar(20)"
     can't use user-defined types in tempdb, so
     varchar(20) is used
  */
  CREATE TABLE #emptyPasswords ( password varchar(20) )
  
  /* turn all user ID to lower case, to get case insensitive comparisons */
  SELECT @nickName = lower(@nickName)

  DECLARE @lastError int
  DECLARE @localTransaction bit
  DECLARE @diffFromGMT int
  DECLARE @currentTime smalldatetime
  DECLARE @userID userIdentifier
  DECLARE @password VPPassword
  SELECT @localTransaction = 1 - sign(@@trancount)
  
  IF @localTransaction = 1
    BEGIN TRAN checkUserRegistration
  
    SELECT @diffFromGMT = gmt
      FROM getGMT
    IF @diffFromGMT IS NULL
      SELECT @diffFromGMT = 0
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

    SELECT @currentTime = dateadd( hour, (-1) * @diffFromGMT, getdate() )

    SELECT @userID = userID
      FROM users
      WHERE nickName = @nickName AND
            users.registrationMode = 2
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      IF @localTransaction = 1
        ROLLBACK TRAN checkUserRegistration
      RETURN @lastError
    END
    
    IF ( @userID IS NULL )
    BEGIN
      SELECT password
      FROM #emptyPasswords
    END
    BEGIN
      SELECT password 
        FROM registration
        WHERE userID = @userID
              /* AND
              deleteDate IS NULL */ /* deleteDate is obsolete */
      
      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        IF @localTransaction = 1
          ROLLBACK TRAN checkUserRegistration
        RETURN @lastError
      END
    END
  IF @localTransaction = 1
    COMMIT TRAN checkUserRegistration
  
END
GO
