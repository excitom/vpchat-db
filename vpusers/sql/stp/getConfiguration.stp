/* get all configuration values 
   from the configuration keys table, 
   for one service
*/
/* input:  service ID (like VP_MT_SERV_USR for users service)
   output: 3 result sets, one for each type of parameters -
           boolean, string, number (by that order)
           for each result set, the columns are
           key ID, key value (whether integer or string)

           NOTE that boolean values are returned as integer
 */
CREATE PROC getConfiguration ( @serviceID serviceID )
AS
BEGIN
  DECLARE @lastError int
  BEGIN TRAN getConfiguration
    SELECT keyID, intValue
      FROM configurationKeys
      WHERE belongsTo = @serviceID AND
            type = 1
      ORDER BY keyID
    SELECT @lastError = @@error
    IF @lastError !=0
    BEGIN
      ROLLBACK TRAN getConfiguration
      RETURN @lastError
    END
    
    SELECT keyID, strValue
      FROM configurationKeys
      WHERE belongsTo = @serviceID AND
            type = 2
      ORDER BY keyID
    SELECT @lastError = @@error
    IF @lastError !=0
    BEGIN
      ROLLBACK TRAN getConfiguration
      RETURN @lastError
    END
    
    SELECT keyID, intValue
      FROM configurationKeys
      WHERE belongsTo = @serviceID AND
            type = 3
      ORDER BY keyID
    SELECT @lastError = @@error
    IF @lastError !=0
    BEGIN
      ROLLBACK TRAN getConfiguration
      RETURN @lastError
    END
    
  COMMIT TRAN getConfiguration
END
GO
