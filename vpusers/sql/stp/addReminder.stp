/*
 * add a reminder for an account
 */
CREATE PROC addReminder ( 
	@accountID	userIdentifier,
	@notifyAcctID	userIdentifier,
	@interval	smallint,
	@repCount	smallint,
	@comment	VARCHAR(255)
)
AS
BEGIN
  DECLARE @lastError	int
  DECLARE @diffFromGMT	int
  DECLARE @notifyDate	VpTime

  BEGIN TRAN
    SELECT @diffFromGMT = gmt
      FROM getGMT
    IF @diffFromGMT IS NULL
      SELECT @diffFromGMT = 0
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END

    SELECT @notifyDate = dateadd( hour, (-1) * @diffFromGMT, getdate() )
    SELECT @notifyDate = dateadd( day, @interval, @notifyDate )
    
    INSERT reminders
      (accountID, notifyAcctID, notifyDate, interval, repCount, comment)
      VALUES 
      (@accountID, @notifyAcctID, @notifyDate, @interval, @repCount, @comment)
   
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END
  COMMIT TRAN
END
GO
