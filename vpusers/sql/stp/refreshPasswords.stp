/* find all new passwords that were changed in the last interval */
CREATE PROC refreshPasswords
AS
BEGIN
  DECLARE @lastError int
  
  BEGIN TRAN refreshPasswords
    /* first find all the passwords that were changed */
    SELECT DISTINCT nickName, email, password
      FROM passwordChanges
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN refreshPasswords
      RETURN @lastError
    END
    
    /* now delete all the password changes records */
    DELETE passwordChanges
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN refreshPasswords
      RETURN @lastError
    END
    
  COMMIT TRAN refreshPasswords
END
GO 
