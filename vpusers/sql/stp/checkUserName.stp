/* 
 * Check if a user name is registered and not deleted.
 * Return:
 *  userID
 *  accountID
 *  user lock flag
 *  accountStatus
 *
 */
CREATE PROC checkUserName ( @userToCheck VPuserID )
AS
BEGIN
  DECLARE @lastError int

  SELECT @userToCheck = ltrim(@userToCheck)
  SELECT @userToCheck = lower(@userToCheck)
  
  DECLARE @userID	userIdentifier
  DECLARE @accountID	userIdentifier
  DECLARE @accountStatus tinyint
  DECLARE @locked	bit

  BEGIN TRAN 
    SELECT @userID = userID, @locked = locked
      FROM users
      WHERE ( registrationMode = 2) AND 
            ( nickName = @userToCheck )
  
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END
      
    IF @userID IS NULL
    BEGIN
      ROLLBACK TRAN
      RETURN 20000
    END

    SELECT @accountID = accountID
      FROM registration
      WHERE userID = @userID
            AND
            deleteDate IS NULL
  
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END

    SELECT @accountStatus = accountStatus
      FROM userAccounts
      WHERE accountID = @accountID
  
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END

    SELECT @userID AS userID, @accountID AS accountID, @locked AS locked, @accountStatus AS accountStatus

  COMMIT TRAN 
  
END
GO 
GRANT EXECUTE ON checkUserName TO audset
GO
