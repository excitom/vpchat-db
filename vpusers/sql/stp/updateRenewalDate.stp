/* update a user account record
 * input:  accountID, renewal date (in local timezone), local timezone
 *  output: Return value - 0 - success 
 *                         20001 - No such account existed in database
 */
CREATE PROC updateRenewalDate (
    @accountID    userIdentifier,
    @renewalDate VpTime,
    @clientTZ    int = 0
)
AS
BEGIN
  DECLARE @lastError int
  DECLARE @aid userIdentifier
  DECLARE @diffFromGMT int
  DECLARE @lastUpdated VpTime
  DECLARE @oldRenewal VpTime
  DECLARE @oldStatus tinyint

  BEGIN TRAN updateRenewalDate

    SELECT @aid = accountID,
           @oldRenewal = renewalDate
      FROM userAccounts
      WHERE accountID = @accountID

    IF @accountID != @aid
    BEGIN
      ROLLBACK TRAN updateRenewalDate
      RETURN 20001
    END
    
    SELECT @diffFromGMT = gmt
      FROM getGMT
    IF @diffFromGMT IS NULL
      SELECT @diffFromGMT = 0
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN  updateRenewalDate
      RETURN @lastError
    END

    SELECT @lastUpdated = dateadd( hour, (-1) * @diffFromGMT, getdate() )
    SELECT @renewalDate = dateadd( hour, (-1) * @clientTZ, @renewalDate )

    /*
     * update the renewal date and the account change time stamp
     */
    UPDATE userAccounts
      SET renewalDate = @renewalDate,
          lastUpdated = @lastUpdated
      WHERE accountID = @accountID
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN updateRenewalDate
      RETURN @lastError
    END
  COMMIT TRAN updateRenewalDate

  /*
   * add history record
   */
  DECLARE @comment VARCHAR(255)
  SELECT @comment = "From: " + CONVERT( VARCHAR(30), dateadd( hour, @clientTZ, @oldRenewal ), 100) + " To: " + CONVERT( VARCHAR(30), dateadd( hour, @clientTZ, @renewalDate ), 100)
  EXEC addAcctHistory @accountID, 9, 0, @comment

  RETURN 0
END
GO
