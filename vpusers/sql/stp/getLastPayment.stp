/* find date of last payment */
/* input:  account ID, flag, 1=debit, 0=credit, if neither specified
			then return most recent of either.

   output: Return value - 0 - success 
                          20001 - No such account existed in database
                          20002 - No payment recorded for this account
*/
CREATE PROC getLastPayment ( @accountID userIdentifier, @debit tinyint = 2 )
AS
BEGIN
  DECLARE @aid userIdentifier
  DECLARE @lastError int
  DECLARE @paymentDate VpTime
  
  BEGIN TRAN
    
    SELECT @aid = accountID
      FROM userAccounts
      WHERE accountID = @accountID
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

    IF @accountID != @aid
    BEGIN
      ROLLBACK TRAN
      RETURN 20001
    END

    IF @debit = 1
    BEGIN
      SELECT @paymentDate = paymentDate
        FROM payments
        WHERE accountID = @aid
        AND amount < 0
        ORDER BY paymentDate ASC

      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN
        RETURN @lastError
      END
    END
    ELSE
    BEGIN
      IF @debit = 0
      BEGIN
        SELECT @paymentDate = paymentDate
          FROM payments
          WHERE accountID = @aid
          AND amount >= 0
          ORDER BY paymentDate ASC
  
        SELECT @lastError = @@error
        IF @lastError != 0
        BEGIN
          ROLLBACK TRAN
          RETURN @lastError
        END
      END
      ELSE
      BEGIN
        SELECT @paymentDate = paymentDate
          FROM payments
          WHERE accountID = @aid
          ORDER BY paymentDate ASC
  
        SELECT @lastError = @@error
        IF @lastError != 0
        BEGIN
          ROLLBACK TRAN
          RETURN @lastError
        END
      END
    END

    IF @paymentDate IS NULL
    BEGIN
      ROLLBACK TRAN
      RETURN 20002
    END

    SELECT @paymentDate AS paymentDate

  COMMIT TRAN
  RETURN 0
END
GO
