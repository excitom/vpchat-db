/* set the password for an account */
/* input:  nickName, password
   output: None */
CREATE PROC SetPassword
( @nickName VPuserID,
  @password varchar(30)
)
AS
BEGIN
  /* turn all user ID to lower case, to get case insensitive comparisons */
  SELECT @nickName = lower(@nickName)
  DECLARE @lastError int
  DECLARE @diffFromGMT int
  DECLARE @currentTime smalldatetime
  
  BEGIN TRAN
    SELECT @diffFromGMT = gmt
      FROM getGMT
    IF @diffFromGMT IS NULL
      SELECT @diffFromGMT = 0
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

    SELECT @currentTime = dateadd( hour, (-1) * @diffFromGMT, getdate() )
    
    UPDATE registration
      SET password = @password, registrationDate = @currentTime
      FROM registration, users
      WHERE users.nickName = @nickName AND
            users.registrationMode = 2 AND
            registration.userID = users.userID
            
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

  COMMIT TRAN
END
GO
