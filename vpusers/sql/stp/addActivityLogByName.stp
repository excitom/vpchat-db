/*
 * Add an account activity log record.
 * input:  name of who is adding the record
 *	   comment
 *	   IP of who is adding the record
 *
 */
CREATE PROC addActivityLogByName ( 
	@name		VPuserID,
	@comment	longName,
	@IP		varchar(20) = NULL,
	@who		VPuserID = NULL
)
AS
BEGIN
  DECLARE @lastError	int
  DECLARE @diffFromGMT  int
  DECLARE @time  	VpTime
  DECLARE @accountID	userIdentifier

  SELECT @diffFromGMT = gmt
    FROM getGMT
  IF @diffFromGMT IS NULL
    SELECT @diffFromGMT = 0
    
  SELECT @lastError = @@error
  IF @lastError != 0
  BEGIN
    RETURN @lastError
  END

  SELECT @time = dateadd( hour, (-1) * @diffFromGMT, getdate() )

  BEGIN TRAN
    
    SELECT @accountID = accountID
      FROM users, registration
      WHERE nickName = @name
      AND   registrationMode = 2
      AND   users.userID = registration.userID
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END
    
    INSERT INTO activityLog ( time, accountID, comment, who, IP )
      VALUES ( @time, @accountID, @comment, @who, @IP )
       
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

  COMMIT TRAN
END
GO
