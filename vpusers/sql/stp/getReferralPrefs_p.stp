/* 
 * Get referral program information for a user account.
 * Input: accountID
 * Output: PHP-friendly single result set
 *         
 *        return 0 - success
 *           20001 - account not found
 *           20002 - account not enrolled
 */
CREATE PROC getReferralPrefs_p ( @accountID userIdentifier )
AS
BEGIN

  DECLARE @lastError   int
  DECLARE @city		VARCHAR(50)
  DECLARE @countrycode	CHAR(2)
  DECLARE @name_first	VARCHAR(50)
  DECLARE @name_last	VARCHAR(50)
  DECLARE @postalcode	VARCHAR(20)
  DECLARE @stateprov	VARCHAR(30)
  DECLARE @street_line1	VARCHAR(50)
  DECLARE @phone_number	VARCHAR(16)
  DECLARE @type		tinyint
  DECLARE @enrollDate	VpTime

  BEGIN TRAN
    DECLARE @enrolled tinyint
    SELECT @enrolled = enrolledReferrer
       FROM userAccounts
       WHERE accountID = @accountID

    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

    IF @enrolled = NULL
    BEGIN
      ROLLBACK TRAN
      RETURN 20001
    END

    IF @enrolled = 0
    BEGIN
      ROLLBACK TRAN
      RETURN 20002
    END
  
    SELECT @type = type, @enrollDate = enrollDate,
           @city = city,
           @countrycode = countrycode,
           @name_first = name_first,
           @name_last = name_last,
           @postalcode = postalcode,
           @stateprov = stateprov,
           @phone_number = phone_number,
           @street_line1 = street_line1
      FROM referralPrefs
      WHERE accountID = @accountID

    IF @type IS NOT NULL
    BEGIN
      SELECT @type AS type, 
      @enrollDate AS enrollDate,
      @city AS city,
      @countrycode AS countrycode,
      @name_first AS name_first,
      @name_last AS name_last,
      @postalcode AS postalcode,
      @stateprov AS stateprov,
      @phone_number AS phone_number,
      @street_line1 AS street_line1
    END
    ELSE
    BEGIN
      ROLLBACK TRAN
      RETURN 20001
    END

  COMMIT TRAN
END
GO 
