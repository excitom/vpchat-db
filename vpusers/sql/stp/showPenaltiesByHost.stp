/* --- show penalties and warnings by a specific host during a date range */
/* this is an interface for calling from an HTML GUI */
/* tom lang - 7/2001 */
CREATE PROC showPenaltiesByHost
( 
  @hostToCheck VPuserID,
  @startDate   smalldatetime,
  @endDate     smalldatetime
)
AS
BEGIN

  DECLARE @lastError int
  DECLARE @diffFromGMT int
  DECLARE @start smalldatetime
  DECLARE @end smalldatetime
  DECLARE @now smalldatetime
  
  BEGIN TRAN
    SELECT @diffFromGMT = gmt
      FROM getGMT
    IF @diffFromGMT IS NULL
      SELECT @diffFromGMT = 0
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END

    SELECT @start = dateadd( hour, (-1) * @diffFromGMT, @startDate )
    SELECT @end   = dateadd( hour, (-1) * @diffFromGMT, @endDate )
    SELECT @now   = dateadd( hour, (-1) * @diffFromGMT, getdate() )

    SELECT Name, 
        "Warn" AS Penalty,
        issuedOn AS "Issued On", 
        issuer AS "Issued By", 
        0 AS "In Effect"
      FROM  warningsWithNames
      WHERE issuer = @hostToCheck
      AND   issuedOn >= @start
      AND   issuedOn <= @end
    UNION
    SELECT Name,
           Penalty, issuedOn AS "Issued On", 
           issuer AS "Issued By", 
           ( (1-forgiven) * 
             (sign(sign(datediff(minute,@now,expiresOn))-1)+1))
             AS "In Effect"
      FROM  penaltiesWithNames
      WHERE issuer = @hostToCheck
      AND   issuedOn >= @start
      AND   issuedOn <= @end
    UNION
    SELECT Name, 
           Penalty, issuedOn AS "Issued On", 
           issuer AS "Issued By", 
           0 AS "In Effect"
      FROM  historyWithNames
      WHERE issuer = @hostToCheck
      AND   issuedOn >= @start
      AND   issuedOn <= @end
    ORDER BY issuedOn
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN
      RETURN @lastError
    END
    COMMIT TRAN
    RETURN
  
  COMMIT TRAN
END
GO 
