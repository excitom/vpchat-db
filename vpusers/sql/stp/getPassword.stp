/* get user's password and account's email 
   input:  user name
   output: password, email of the acct owner, acct status, accountID

   Note: This is a quirky little stored procedure, finely tuned to the
   lost-password-recovery web page. 
*/
CREATE PROC getPassword ( @nickName VPuserID )
AS
BEGIN
  DECLARE @accountID userIdentifier
  DECLARE @ownerID   userIdentifier
  DECLARE @userID    userIdentifier
  DECLARE @password  VPPassword
  DECLARE @email     longName
  DECLARE @accountStatus tinyInt
  DECLARE @acctOwner bit
  DECLARE @lastError int

  BEGIN TRAN
    SELECT @nickName = lower(@nickName)

    SELECT @accountID = accountID,
           @password  = password,
	   @userID    = users.userID
      FROM registration,users
      WHERE nickName = @nickName
      AND   registrationMode = 2
      AND   users.userID = registration.userID
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END

    IF @userID = NULL
    BEGIN
      SELECT 0
      COMMIT TRAN 
      RETURN 0
    END

    SELECT @accountStatus = accountStatus,
           @ownerID = ownerID,
           @email = email
      FROM  userAccounts
      WHERE accountID = @accountID
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END

    IF @ownerID = @userID
    BEGIN
      SELECT @acctOwner = 1
    END
    ELSE BEGIN
      SELECT @acctOwner = 0
    END

    SELECT 1, @accountStatus, @acctOwner, @accountID
    SELECT 2, @password
    SELECT 3, @email
  COMMIT TRAN
END
GO 
