/* get the usage statistics for a given period of time, by day
   NOTE: dailyUsage is used, so statistics are good only
         up to the previous day

  INPUT  : startTime, endTime
  OUTPUT : time, 
           summary values - ( all users, chat users, Buddy list users ) X 
                            (average, minimum, maximum)

           e.g. if summary is desired for period starting on 
           January 1st 1997, and ending on January 15th 1997, values will look like this:

           1997 1 1 00:00 <all-avg> <all-min> <all-max>...<bl-avg> <bl-min> <bl-max>
           1997 1 2 00:00 <all-avg> <all-min> <all-max>...<bl-avg> <bl-min> <bl-max>
           1997 1 3 00:00 <all-avg> <all-min> <all-max>...<bl-avg> <bl-min> <bl-max>
            .   . . .       .        .
            .   . . .       .        .
            .   . . .       .        .
            .   . . .       .        .
            .   . . .       .        .
           1997 1 15 00:00 <all-avg> <all-min> <all-max>...<bl-avg> <bl-min> <bl-max>

           where each <braced value> is a 4-byte-representable integer.
*/
CREATE PROC getDailyStatistics
(
  @startTime VpTime,
  @endTime VpTime
)
AS
BEGIN
  /* first fix times to include each possible entry from the given days */
  /* make @startTime be 00:00 of the day on which @startTime belongs to */
  SELECT @startTime = dateadd( hour, (-1) * datepart(hour,@startTime), @startTime )
  SELECT @startTime = dateadd( minute, (-1) * datepart(minute,@startTime), @startTime )
  
  /* make @endTime be 23:59 of the day to which @endTime belongs to */
  SELECT @endTime = dateadd( hour, 23 - datepart(hour,@endTime), @endTime )
  SELECT @endTime = dateadd( minute, 59 - datepart(minute,@endTime), @endTime )

  SELECT DISTINCT
         year=datepart( year, d1.time), 
         month=datepart( month, d1.time), 
         day=datepart( day, d1.time),
         hour=0, /* daily summary, so hour is meaningless */
         allAvg=avg(d1.value),
         allMin=min(d2.value),
         allMax=max(d3.value),
         chatAvg=avg(d4.value),
         chatMin=min(d5.value),
         chatMax=max(d6.value),
         BlAvg=avg(d7.value),
         BlMin=min(d8.value),
         BlMax=max(d9.value)
  FROM
         dailyUsage d1,
         dailyUsage d2,
         dailyUsage d3,
         dailyUsage d4,
         dailyUsage d5,
         dailyUsage d6,
         dailyUsage d7,
         dailyUsage d8,
         dailyUsage d9
  WHERE	    
         ( d1.time BETWEEN @startTime AND @endTime ) AND
         ( d2.time BETWEEN @startTime AND @endTime ) AND
         ( d3.time BETWEEN @startTime AND @endTime ) AND
         ( d4.time BETWEEN @startTime AND @endTime ) AND
         ( d5.time BETWEEN @startTime AND @endTime ) AND
         ( d6.time BETWEEN @startTime AND @endTime ) AND
         ( d7.time BETWEEN @startTime AND @endTime ) AND
         ( d8.time BETWEEN @startTime AND @endTime ) AND
         ( d9.time BETWEEN @startTime AND @endTime ) AND
         ( datepart(year,d2.time) = datepart(year,d1.time) ) AND
         ( datepart(month,d2.time) = datepart(month,d1.time) ) AND
         ( datepart(day,d2.time) = datepart(day,d1.time) ) AND
         ( datepart(year,d3.time) = datepart(year,d2.time) ) AND
         ( datepart(month,d3.time) = datepart(month,d2.time) ) AND
         ( datepart(day,d3.time) = datepart(day,d2.time) ) AND
         ( datepart(year,d4.time) = datepart(year,d3.time) ) AND
         ( datepart(month,d4.time) = datepart(month,d3.time) ) AND
         ( datepart(day,d4.time) = datepart(day,d3.time) ) AND
         ( datepart(year,d5.time) = datepart(year,d4.time) ) AND
         ( datepart(month,d5.time) = datepart(month,d4.time) ) AND
         ( datepart(day,d5.time) = datepart(day,d4.time) ) AND
         ( datepart(year,d6.time) = datepart(year,d5.time) ) AND
         ( datepart(month,d6.time) = datepart(month,d5.time) ) AND
         ( datepart(day,d6.time) = datepart(day,d5.time) ) AND
         ( datepart(year,d7.time) = datepart(year,d6.time) ) AND
         ( datepart(month,d7.time) = datepart(month,d6.time) ) AND
         ( datepart(day,d7.time) = datepart(day,d6.time) ) AND
         ( datepart(year,d8.time) = datepart(year,d7.time) ) AND
         ( datepart(month,d8.time) = datepart(month,d7.time) ) AND
         ( datepart(day,d8.time) = datepart(day,d7.time) ) AND
         ( datepart(year,d9.time) = datepart(year,d8.time) ) AND
         ( datepart(month,d9.time) = datepart(month,d8.time) ) AND
         ( datepart(day,d9.time) = datepart(day,d8.time) ) AND
         (d1.userType=0) AND (d1.valueType=0) AND
         (d2.userType=0) AND (d2.valueType=1) AND
         (d3.userType=0) AND (d3.valueType=2) AND
         (d4.userType=1) AND (d4.valueType=0) AND
         (d5.userType=1) AND (d5.valueType=1) AND
         (d6.userType=1) AND (d6.valueType=2) AND
         (d7.userType=2) AND (d7.valueType=0) AND
         (d8.userType=2) AND (d8.valueType=1) AND
         (d9.userType=2) AND (d9.valueType=2)

  ORDER BY year, month, day, hour


END
GO 
