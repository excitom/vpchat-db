/* add (or update if an entry with the same serial 
   number already exists) the record for a
   Persistent-Places-To-Go list item. */
/* input:  serial number in list, type of place,
           URL, title, roomUsage, corrUsage
   output: NONE
*/
CREATE PROC addPPtgItem
(
  @serialNumber	integer,
  @type		integer,
  @URL		varchar(255),
  @title	varchar(255),
  @roomUsage	integer,
  @corrUsage	integer
)
AS
BEGIN  
  DECLARE @lastError int
  DECLARE @insideTransaction int
  DECLARE @matchFound bit

  IF ( @@trancount > 0 )
    SELECT @insideTransaction = 1
  ELSE 
    SELECT @insideTransaction = 0

  IF ( @insideTransaction = 0 )
    BEGIN TRAN addPtgItem

    /* first check if the auditorium exists */
    IF EXISTS (
      SELECT serialNumber
        FROM PersistentPTGlist
        WHERE serialNumber = @serialNumber 
	AND type = @type)
      SELECT @matchFound = 1
    ELSE
      SELECT @matchFound = 0
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      raiserror @lastError
      ROLLBACK TRAN
      RETURN @lastError
    END
    
    IF @matchFound = 1
    BEGIN
      /* update existing entry */
      UPDATE PersistentPTGlist
        SET title = @title,
            URL = @URL,
            roomUsage = @roomUsage,
	    corrUsage = @corrUsage
        FROM PersistentPTGlist
        WHERE serialNumber = @serialNumber
	AND type = @type
    END
    ELSE
    BEGIN
      /* insert a new entry */
      INSERT PersistentPTGlist
        VALUES ( @serialNumber, @URL, @title, @type, @roomUsage, @corrUsage )
    END

    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      raiserror @lastError
      ROLLBACK TRAN
      RETURN @lastError
    END
    
  IF ( @insideTransaction = 0 )
    COMMIT TRAN addPtgItem
END
GO
