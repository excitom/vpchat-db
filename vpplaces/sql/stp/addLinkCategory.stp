/* add a new category of related HTML links */
/*
  INPUT  : category description (name), parent category
  OUTPUT : ID of new category
           return value - 0 if successful
                          20001 if parent category does not exist
                          20002 if category with the same name is 
                                already defined for that parent category
*/
CREATE PROC addLinkCategory
(
  @description VARCHAR(128),
  @parentCategory categoryIdentifier = NULL
)
AS
BEGIN
  DECLARE @lastError int
  DECLARE @category categoryIdentifier
  DECLARE @oldCategory varchar(128)
  
  BEGIN TRAN addLinkCategory
    IF ( @parentCategory IS NOT NULL )
    BEGIN
      /* check if the given parent category exists */
      SELECT @category = category
        FROM linkCategories
        WHERE ( category = @parentCategory )
      
      SELECT @lastError = @@error
      IF @lastError != 0
      BEGIN
        ROLLBACK TRAN addLinkCategory
        RETURN @lastError
      END
      
      IF ( @category IS NULL )
      BEGIN
        ROLLBACK TRAN addLinkCategory
        RETURN 20001
      END
    END
    
    SELECT @oldCategory = category
      FROM linkCategories
      WHERE ( parentCategory = @parentCategory ) AND
            ( description = @description )
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN addLinkCategory
      RETURN @lastError
    END
    
    IF ( @oldCategory IS NOT NULL )
    BEGIN
      ROLLBACK TRAN addLinkCategory
      RETURN 20002
    END
    
    INSERT linkCategories ( parentCategory, description )
      VALUES ( @parentCategory, @description )
    
    SELECT @lastError = @@error

    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN addLinkCategory
      RETURN @lastError
    END

    IF NOT EXISTS (SELECT description FROM html WHERE description = @description)
    BEGIN
      INSERT html (description) VALUES (@description)
    END
      
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN 
      RETURN @lastError
    END
    
    SELECT category
      FROM linkCategories
      WHERE ( parentCategory = @parentCategory ) AND
            ( description = @description )
    
  COMMIT TRAN addLinkCategory
END
GO 
