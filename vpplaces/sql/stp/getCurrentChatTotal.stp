/*
get total number of chatters = 
total numbe of users - total number of buddy list users 
*/
CREATE PROC getCurrentChatTotal
AS
BEGIN
  DECLARE @lastError int
  DECLARE @BLTotal int
  DECLARE @roomUsage int
  DECLARE @corrUsage int
  DECLARE @time VpTime
  
  BEGIN TRAN getCurrentChatTotal
    SELECT @time = max(time)
      FROM totalUsage
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN getCurrentChatTotal
      SELECT roomUsage = 0, corrUsage = 0
      RETURN @lastError
    END
    
    SELECT @roomUsage = roomUsage, @corrUsage = corrUsage, @BLTotal = BLUsage
      FROM totalUsage
      WHERE time = @time
    
    SELECT @lastError = @@error
    IF @lastError != 0
    BEGIN
      ROLLBACK TRAN getCurrentChatTotal
      SELECT roomUsage = 0, corrUsage = 0
      RETURN @lastError
    END
    
    IF @roomUsage IS NULL
      SELECT @roomUsage = 0
    IF @corrUsage IS NULL
      SELECT @corrUsage = 0
    IF @BLTotal IS NULL
      SELECT @BLTotal = 0
    
    SELECT roomUsage = @roomUsage, corrUsage = @corrUsage
    
  COMMIT TRAN getCurrentChatTotal
END
GO
